<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>Regiona Rail Station Crime Heat Map</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        
        <!--    Leaflet
        ------------------------------------------------------->
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
        
        <!--   Leaflet Plugin
        ------------------------------------------------------->
        <script src="/leaflet-plugins/layer/vector/KML.js"></script>
        
        <!--    jQuery
        -------------------------------------------------------->
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

        <!--    HeatMap.js mod
        -------------------------------------------------------->
        <script src="/js/heatmapjs/src/QuadTree.js"></script>
        <script src="/js/heatmapjs/src/heatmap.js"></script>
        <script src="/js/heatmapjs/src/heatmap-leaflet-jsmiley-edit.js"></script>
        
        <link href="style.css" rel="stylesheet" />
        
    </head>
    <body>
        <div id="map"></div>
        <script>
            
            $( document ).ready( function() {
                var map = L.map('map').setView([39.952335, -75.163789], 12);
                
                // add an OpenStreetMap tile layer
                L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
                    key: "15b9654db9074459a87d7646af8c565b",
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
                    styleId: 22677
                }).addTo(map);
                
                var routes      = new L.KML("regionalrail.kml", {async: true}).addTo(map);
                var cityLimits  = new L.KML("city_limits.kml", {async: true}).addTo(map);
                //map.addLayer( routes );
                
                $.getJSON( 'regional_rail_stop_crime_count.json', function( data ) {
                    console.log( data );

                    heatmapPoints = new Array();
                    jQuery.each(data.stations, function() {
                        rail_stop = this;
                        
                        lat = rail_stop.stop_lat;
                        lng = rail_stop.stop_lon;
                        crimeCount = rail_stop.count;
                        
                        if( crimeCount > 0 ) {
                            var marker = L.marker([ lat, lng ]).addTo(map);
                            heatmapPoints.push( { "lat":lat, "lon":lng, "value": crimeCount } );
                        }
                    });
                    
                    var heatmapLayer = L.TileLayer.heatMap({
                        radius: 50,
                        opacity: 0.8,
                        gradient: {
                            0: "rgb(0,0,0)",
                            0.45: "rgb(0,0,255)",
                            0.55: "rgb(0,255,255)",
                            0.65: "rgb(0,255,0)",
                            0.75: "yellow",
                            1.0: "rgb(255,0,0)"
                        }
                    });

                    console.log( heatmapPoints );
                    heatmapLayer.setData(186,heatmapPoints);
                    
                    var overlayMaps = {
                    'Heatmap': heatmapLayer
                };
 
                var controls = L.control.layers(null, overlayMaps, {collapsed: false});
                controls.addTo(map);
                heatmapLayer.addTo(map);    
                }).fail(function( err, ajaxOptions, thrownError) {
                    console.log( 'ajax error, messages follow' );
                    console.log( err.status );
                    console.log( thrownError );
                  });
            });
        </script>
    </body>
    
    
</html>
